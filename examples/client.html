<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Socket client test</title>
</head>
<body>
<h1>WebSocket Test</h1>
<h3>Look into browser console</h3>
<div id="output"></div>
<button onclick="Socket.send(document.URL);">Send page</button>

<script>
    "use strict";

    window.addEventListener("load", init, false);
    document.cookie="username=John Doe; expires=Thu, 18 Dec 2016 12:00:00 UTC; path=/";

    /**
     * <!-- Use only for test connection -->
     */
    var output;

    function init() {
        output = document.getElementById("output");
    }

    function writeToScreen(message) {
        var pre = document.createElement("p");
        pre.style.wordWrap = "break-word";
        pre.innerHTML = message;
        output.appendChild(pre);
    }

    /**
     * <!-- Use only for test connection -->
     */

    /**
     *  Using for production
     */
    var Socket = {

        /**
         * Is WebSockets support
         *
         * @type {boolean}
         */
        isSupported : ("WebSocket" in window && window.WebSocket != undefined),

        /**
         * Connection config
         */
        config : {
            protocol : 'ws://',
            host: '127.0.0.1',
            port: 9003,
            route: '/sonar',
        },

        /**
         * Create socket connect
         *
         * @param {string} page
         * @return Socket
         */
        create : function() {

            if(!this.isSupported)
                throw Error('Websockets dooes not supported');

            console.info('[CONFIG]', this.config);

            /**
             * @type {WebSocket}
             */
            var connect = new WebSocket(this.config.protocol + this.config.host +':'+this.config.port+''+this.config.route);

            // socket connect event
            connect.onopen = function connectionOpened() {
                writeToScreen('[SOCKET] Open connect');
                console.info('[SOCKET] Open connect');
            };

            // socket message event
            connect.onmessage = function messageReceived(message) {
                writeToScreen('<span style="color: blue;">[SOCKET] Send: ' + message.data+'</span>')
                console.info('[SOCKET] Send', message.data);
            };

            // socket close event
            connect.onclose = function() {
                writeToScreen('[SOCKET] Close');
                console.info('[SOCKET] Close');
            };

            // socket error event
            connect.onerror = function(event) {
                writeToScreen('<span style="color: red;">[SOCKET] Error:</span> ' + event.data);
                console.info('[SOCKET] Error: '+event.data);
            };

            this.connect = connect;

            return this;
        },

        /**
         * Access watching
         *
         * @param {WebSocket} socket
         * @param {function} callback
         */
        wait : function(socket, callback) {

            var then = this;

            setTimeout(function() {
                if(socket.readyState === socket.OPEN) {
                    callback();
                } else {
                    then.wait(socket, callback);
                }
            }, 5);
        },

        /**
         * Send data to server
         *
         * @param {string} url
         */
        send : function(url) {

            console.info('[SEND]', url);

            var then = this;
            this.wait(this.connect, function() {
                then.connect.send(JSON.stringify({'page' : url}));
            });
        }
    };

    // run
    Socket.create().send(document.URL);
</script>
</body>
</html>